.386
.model flat, stdcall
option casemap:none

include \masm32\include\windows.inc
include \masm32\include\kernel32.inc
include \masm32\include\user32.inc
include \masm32\include\gdi32.inc

includelib \masm32\lib\kernel32.lib
includelib \masm32\lib\user32.lib
includelib \masm32\lib\gdi32.lib

WinMain PROTO :DWORD,:DWORD,:DWORD,:DWORD

ID_TIMER equ 1

.data
ClassName db "SnowmanClass",0
AppName   db "Тающий снеговик",0

Text1 db "Анимация: Тающий снеговик",0
Font1Name db "Times New Roman",0

hInstance dd ?
hWnd dd ?

meltStage dd 0
sunX dd 50
sunVisible dd 0

.data?
ps PAINTSTRUCT <>
hFont1 dd ?

.code

start:
    invoke GetModuleHandle,NULL
    mov hInstance,eax
    invoke WinMain,hInstance,NULL,NULL,SW_SHOWDEFAULT
    invoke ExitProcess,eax

WinMain proc hInst:DWORD,hPrev:DWORD,Cmd:DWORD,Show:DWORD
    LOCAL wc:WNDCLASSEX
    LOCAL msg:MSG

    mov wc.cbSize,SIZEOF WNDCLASSEX
    mov wc.style,CS_HREDRAW or CS_VREDRAW
    mov wc.lpfnWndProc,OFFSET WndProc
    mov wc.cbClsExtra,0
    mov wc.cbWndExtra,0
    mov wc.hInstance,hInst
    mov wc.hbrBackground,COLOR_WINDOW+1
    mov wc.lpszMenuName,NULL
    mov wc.lpszClassName,OFFSET ClassName

    invoke LoadCursor,NULL,IDC_ARROW
    mov wc.hCursor,eax
    invoke LoadIcon,NULL,IDI_APPLICATION
    mov wc.hIcon,eax
    mov wc.hIconSm,eax

    invoke RegisterClassEx,ADDR wc

    invoke CreateWindowEx,0,ADDR ClassName,ADDR AppName,\
        WS_OVERLAPPEDWINDOW,100,100,800,600,\
        NULL,NULL,hInst,NULL
    mov hWnd,eax

    invoke ShowWindow,hWnd,Show
    invoke UpdateWindow,hWnd

    .while TRUE
        invoke GetMessage,ADDR msg,NULL,0,0
        .break .if eax==0
        invoke TranslateMessage,ADDR msg
        invoke DispatchMessage,ADDR msg
    .endw

    mov eax,msg.wParam
    ret
WinMain endp

DrawSun proc hdc:DWORD, x:DWORD, y:DWORD
    invoke CreateSolidBrush, 0000FFFFh
    invoke SelectObject, hdc, eax
    push eax

    mov eax, x
    sub eax, 30
    mov ebx, y
    sub ebx, 30
    mov ecx, x
    add ecx, 30
    mov edx, y
    add edx, 30
    invoke Ellipse, hdc, eax, ebx, ecx, edx

    pop eax
    invoke SelectObject, hdc, eax
    invoke DeleteObject, eax
    ret
DrawSun endp

DrawSnowman proc hdc:DWORD, stage:DWORD
    mov eax, 100
    sub eax, stage
    mov ebx, eax

    invoke CreateSolidBrush, 00FFFFFFh
    invoke SelectObject, hdc, eax
    push eax

    invoke Ellipse, hdc, 350, 300, 450, 400
    invoke Ellipse, hdc, 370, 250, 430, 310

    pop eax
    invoke SelectObject, hdc, eax
    invoke DeleteObject, eax
    ret
DrawSnowman endp

WndProc proc hWnd:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD
    LOCAL hdc:DWORD

    .if uMsg==WM_CREATE
        invoke CreateFont,24,0,0,0,FW_BOLD,0,0,0,\
            DEFAULT_CHARSET,0,0,0,0,ADDR Font1Name
        mov hFont1,eax
        invoke SetTimer,hWnd,ID_TIMER,100,NULL

    .elseif uMsg==WM_TIMER
        add sunX,10
        .if sunX>300
            mov sunVisible,1
            .if meltStage<50
                inc meltStage
            .endif
        .endif
        invoke InvalidateRect,hWnd,NULL,TRUE

    .elseif uMsg==WM_PAINT
        invoke BeginPaint,hWnd,ADDR ps
        mov hdc,eax

        invoke SelectObject,hdc,hFont1
        invoke TextOut,hdc,20,20,ADDR Text1,LENGTHOF Text1-1

        .if sunVisible==1
            invoke DrawSun,hdc,sunX,80
        .endif

        invoke DrawSnowman,hdc,meltStage

        invoke EndPaint,hWnd,ADDR ps

    .elseif uMsg==WM_DESTROY
        invoke KillTimer,hWnd,ID_TIMER
        invoke DeleteObject,hFont1
        invoke PostQuitMessage,0

    .else
        invoke DefWindowProc,hWnd,uMsg,wParam,lParam
        ret
    .endif

    xor eax,eax
    ret
WndProc endp

end start

.386
.model flat, stdcall
option casemap:none

include \masm32\include\windows.inc
include \masm32\include\user32.inc
include \masm32\include\kernel32.inc
include \masm32\include\gdi32.inc

includelib \masm32\lib\user32.lib
includelib \masm32\lib\kernel32.lib
includelib \masm32\lib\gdi32.lib

WinMain PROTO :DWORD,:DWORD,:DWORD,:DWORD

ID_TIMER equ 1

.data
ClassName db "SnowAnimClass",0
AppName   db "Taющий снеговик (GDI)",0

hInstance dd ?
hWnd      dd ?

sunX      dd 30
sunShow   dd 0
radius    dd 80

.data?
ps PAINTSTRUCT <>
hWhiteBrush dd ?
hYellowBrush dd ?

.code

start:
    invoke GetModuleHandle, NULL
    mov hInstance, eax
    invoke WinMain, hInstance, NULL, NULL, SW_SHOWDEFAULT
    invoke ExitProcess, eax

; -------------------------------------------------
WinMain proc hInst:DWORD, hPrev:DWORD, Cmd:DWORD, Show:DWORD
    LOCAL wc:WNDCLASSEX
    LOCAL msg:MSG

    mov wc.cbSize, SIZEOF WNDCLASSEX
    mov wc.style, CS_HREDRAW or CS_VREDRAW
    mov wc.lpfnWndProc, OFFSET WndProc
    mov wc.cbClsExtra, 0
    mov wc.cbWndExtra, 0
    mov wc.hInstance, hInst
    mov wc.hbrBackground, COLOR_WINDOW+1
    mov wc.lpszMenuName, NULL
    mov wc.lpszClassName, OFFSET ClassName

    invoke LoadCursor, NULL, IDC_ARROW
    mov wc.hCursor, eax
    invoke LoadIcon, NULL, IDI_APPLICATION
    mov wc.hIcon, eax
    mov wc.hIconSm, eax

    invoke RegisterClassEx, ADDR wc

    invoke CreateWindowEx, 0, ADDR ClassName, ADDR AppName,\
        WS_OVERLAPPEDWINDOW, 200, 150, 800, 600,\
        NULL, NULL, hInst, NULL

    mov hWnd, eax

    invoke ShowWindow, hWnd, Show
    invoke UpdateWindow, hWnd

msg_loop:
    invoke GetMessage, ADDR msg, NULL, 0, 0
    cmp eax, 0
    je exit_loop
    invoke TranslateMessage, ADDR msg
    invoke DispatchMessage, ADDR msg
    jmp msg_loop

exit_loop:
    mov eax, msg.wParam
    ret
WinMain endp

; -------------------------------------------------
WndProc proc hWnd:DWORD, uMsg:DWORD, wParam:DWORD, lParam:DWORD
    LOCAL hdc:HDC

    .if uMsg == WM_CREATE
        invoke CreateSolidBrush, 00FFFFFFh
        mov hWhiteBrush, eax
        invoke CreateSolidBrush, 0000FFFFh
        mov hYellowBrush, eax
        invoke SetTimer, hWnd, ID_TIMER, 80, NULL

    .elseif uMsg == WM_TIMER
        add sunX, 6
        .if sunX > 200
            mov sunShow, 1
            .if radius > 10
                sub radius, 2
            .endif
        .endif
        invoke InvalidateRect, hWnd, NULL, TRUE

    .elseif uMsg == WM_PAINT
        invoke BeginPaint, hWnd, ADDR ps
        mov hdc, eax

        ; ---- Sun ----
        .if sunShow == 1
            invoke SelectObject, hdc, hYellowBrush
            invoke Ellipse, hdc, sunX, 40, sunX+60, 100
        .endif

        ; ---- Snowman ----
        invoke SelectObject, hdc, hWhiteBrush

        mov eax, radius
        mov ebx, 400
        sub ebx, eax
        mov ecx, 400
        add ecx, eax
        mov edx, 500
        add edx, eax
        invoke Ellipse, hdc, ebx, 420, ecx, edx

        mov eax, radius
        sub eax, 20
        mov ebx, 400
        sub ebx, eax
        mov ecx, 400
        add ecx, eax
        invoke Ellipse, hdc, ebx, 360, ecx, 420

        invoke EndPaint, hWnd, ADDR ps

    .elseif uMsg == WM_DESTROY
        invoke KillTimer, hWnd, ID_TIMER
        invoke DeleteObject, hWhiteBrush
        invoke DeleteObject, hYellowBrush
        invoke PostQuitMessage, 0

    .else
        invoke DefWindowProc, hWnd, uMsg, wParam, lParam
        ret
    .endif

    xor eax, eax
    ret
WndProc endp

end start
